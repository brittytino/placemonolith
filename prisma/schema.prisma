generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// --------------------------------------------------------
// SUPER ADMIN / PLACEMENT REP (One per Batch)
// --------------------------------------------------------

model PlacementRep {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed
  name      String
  
  // A Rep manages exactly one batch at a time (usually)
  managedBatch Batch?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --------------------------------------------------------
// BATCH MANAGEMENT
// --------------------------------------------------------

enum BatchStatus {
  PLACEMENT_ACTIVE
  PREPARATION_ACTIVE
  ARCHIVED
}

model Batch {
  id              String      @id @default(cuid())
  name            String      // e.g. "MCA 2024â€“2026"
  startYear       Int
  endYear         Int
  status          BatchStatus @default(PREPARATION_ACTIVE)
  
  // One rep per batch
  placementRepId  String      @unique
  placementRep    PlacementRep @relation(fields: [placementRepId], references: [id])

  students        Student[]
  drives          Drive[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([status])
}

// --------------------------------------------------------
// STUDENT DATA
// --------------------------------------------------------

model Student {
  id              String   @id @default(cuid())
  name            String
  rollNo          String   @unique
  email           String   @unique
  password        String   // Hashed (for login)
  
  // Academic & Profile
  cgpa            Float?
  resumeUrl       String?
  
  // Relations
  batchId         String
  batch           Batch    @relation(fields: [batchId], references: [id])
  
  participations  StudentDriveParticipation[]
  roundOutcomes   RoundOutcome[]
  
  // Class Rep Role (Simple boolean flag or separate relation if needed, 
  // keeping it simple as per "Class Representatives" role desc)
  isClassRep      Boolean  @default(false)
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([batchId])
}

// --------------------------------------------------------
// COMPANY & DRIVES
// --------------------------------------------------------

model Company {
  id        String   @id @default(cuid())
  name      String   @unique
  domain    String?  // e.g. "Fintech", "EdTech"
  notes     String?  // Persistent notes across batches
  website   String?

  drives    Drive[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Drive {
  id                  String   @id @default(cuid())
  role                String   // e.g. "SDE-1"
  package             String?  // e.g. "12 LPA"
  eligibilityCriteria String?  // Text description
  driveDate           DateTime
  
  // Relations
  companyId           String
  company             Company  @relation(fields: [companyId], references: [id])

  batchId             String
  batch               Batch    @relation(fields: [batchId], references: [id])

  rounds              Round[]
  participations      StudentDriveParticipation[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([batchId])
  @@index([companyId])
}

// --------------------------------------------------------
// ROUNDS & OUTCOMES
// --------------------------------------------------------

model Round {
  id          String   @id @default(cuid())
  name        String   // OA, Tech 1, HR
  orderIndex  Int      // 1, 2, 3...
  
  driveId     String
  drive       Drive    @relation(fields: [driveId], references: [id], onDelete: Cascade)
  
  outcomes    RoundOutcome[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum DriveStatus {
  IN_PROGRESS
  ELIMINATED
  OFFERED
}

model StudentDriveParticipation {
  id            String      @id @default(cuid())
  
  studentId     String
  student       Student     @relation(fields: [studentId], references: [id])
  
  driveId       String
  drive         Drive       @relation(fields: [driveId], references: [id])
  
  currentStatus DriveStatus @default(IN_PROGRESS)

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([studentId, driveId])
}

enum RoundResult {
  PASS
  FAIL
}

model RoundOutcome {
  id              String      @id @default(cuid())
  
  attended        Boolean     @default(false)
  result          RoundResult?
  failureReason   String?     // Optional text
  questionsAsked  String?     // "The Knowledge"
  difficultyRating Int?       // 1-5
  studentReflection String?   // "The Memory"
  
  // Verification
  isVerified      Boolean     @default(false)
  verifiedBy      String?     // ID of rep who verified

  // Relations
  studentId       String
  student         Student     @relation(fields: [studentId], references: [id])
  
  roundId         String
  round           Round       @relation(fields: [roundId], references: [id])

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([studentId, roundId])
  @@index([result])
}

